from multiprocessing import Process, Pool
from util import *
import pexpect
from config import Config
import requests


def _exploit(exploit, target):
    from backend import flagcollection
    p = pexpect.spawn(exploit)
    while p.isalive():
        flag = p.readline().decode().strip()
        if flag != '':
            requests.post('http://127.0.0.1:8080/submit', data={'flag': flag, 'exploit': exploit, 'target': target})


class Exploiter:

    @staticmethod
    def start():
        pool = Pool(Config.Exploiter.PoolSize)
        exploits = get_exploits()
        targets = get_targets()

        for exploit in exploits:
            for target in targets:
                pool.apply_async(_exploit, (exploit, target))


if __name__ == '__main__':
    Exploiter.start()
